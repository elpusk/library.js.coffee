<!--
/**
 * @license MIT
 * Copyright (c) 2020 Elpusk.Co.,Ltd.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>websocket test for IPv6</title>
    <script language="javascript" type="text/javascript">
    //var wsUri = "ws://192.168.10.103:8080";
        var wsUri = "ws://[2001:0:2851:782c:304f:27b9:85db:6e5]:8080";
        //var wsUri = "ws://[fe80::9120:fd98:77d4:cb32%7]:8080";
        //var wsUri = "ws://[fe80::1810:1b75:85db:6e5%5]:8080";
    //var wsUri;
    var output;
    var nCount = 0;
    var sMax = "5";

    /**
     * Get the user IP throught the webkitRTCPeerConnection
     * @param onNewIP {Function} listener function to expose the IP locally
     * @return undefined
     */
    function getUserIP(onNewIP) { //  onNewIp - your listener function for new IPs
        //compatibility for firefox and chrome
        var myPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
        var pc = new myPeerConnection({
            iceServers: []
        }),
        noop = function () { },
        localIPs = {},
        ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g,
        key;

        function iterateIP(ip) {
            if (!localIPs[ip]) onNewIP(ip);
            localIPs[ip] = true;
        }

        //create a bogus data channel
        pc.createDataChannel("");

        // create offer and set local description
        pc.createOffer().then(function (sdp) {
            sdp.sdp.split('\n').forEach(function (line) {
                if (line.indexOf('candidate') < 0) return;
                line.match(ipRegex).forEach(iterateIP);
            });

            pc.setLocalDescription(sdp, noop, noop);
        }).catch(function (reason) {
            // An error occurred, so handle the failure to connect
        });

        //listen for candidate events
        pc.onicecandidate = function (ice) {
            if (!ice || !ice.candidate || !ice.candidate.candidate || !ice.candidate.candidate.match(ipRegex)) return;
            ice.candidate.candidate.match(ipRegex).forEach(iterateIP);
        };
    }


    function init()
    {
        output = document.getElementById("output");
        /*
        getUserIP(function (ip) {
            alert("Got IP! :" + ip);
        });
        */
        test_web_socket();
        /*
        getLocalIP().then((ipAddr) => {
            wsUri = "ws://"+ipAddr + ":8080";
            test_web_socket();
        });
        */
    }

    function test_web_socket()
    {
        websocket = new WebSocket(wsUri, "elpusk.protocol.coffee.manager");
        //websocket = new WebSocket(wsUri);
        websocket.onopen = function (evt) { onOpen(evt); }
        websocket.onclose = function (evt) { onClose(evt); }
        websocket.onmessage = function (evt) { onMessage(evt); }
        websocket.onerror = function (evt) { onError(evt); }
    }

    function onOpen(evt)
    {
        writeToScreen("opend");
        doSend(nCount.toString());
    }

    function onClose(evt) {
        writeToScreen("closed");
    }

    function onMessage(evt) {
        writeToScreen('<span style="color: blue;">received: ' + evt.data + '</span>');
        if (evt.data == sMax)
            websocket.close();
        else {
            nCount++;
            doSend(nCount.toString());
        }
     
    }

    function onError(evt) {
        writeToScreen('<span style="color: res;">error: ' + evt.data + '</span>');
    }

    function doSend(message)
    {
        writeToScreen(message);
        websocket.send(message);
    }

    function writeToScreen(message)
    {
        var pre = document.createElement("p");
        pre.style.wordWrap = "break-word";
        pre.innerHTML = message;
        output.appendChild(pre);
    }

    window.addEventListener("load", init, false);

    </script>
</head>
<body>
    <h2>websocket test for IPv6</h2>
    <div id="output"></div>
</body>
</html>