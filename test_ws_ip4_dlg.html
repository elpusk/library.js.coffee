<!DOCTYPE html>

<HTML>
<HEAD>
    <meta charset="utf-8" />

    <TITLE>websocket test for ip4 with dialog</TITLE>
    <script src="scripts/tools.js"></script>
    <script src="scripts/elpusk.device.js"></script>

    <script type="text/javascript">
        var wsUri;
        var nCount = 0;
        var sMax = "5";
        var sSessionServer;
        var sDeviceIndex;

        function init() {
            nCount = 0;
            //wsUri = "ws://localhost:8080";
            wsUri = "ws://127.0.0.1:80";
            writeToScreen("your ip address : " + wsUri);
        }

        function onOpen(evt)
        {
            writeToScreen("opend");
        }

        function onClose(evt) {
            //$("DropList").empty();

            var select_dev = document.getElementById("drop_list_device");
            var i;
            for (i = select_dev.options.length - 1; i >= 0; i--) {
                select_dev.remove(i);
            }
            writeToScreen("closed");
        }

        function onMessage_json_format(evt) {
            var json_obj = JSON.parse(evt.data);
            if (nCount == 0) {
                sSessionServer = json_obj.session_number.toString();
                nCount++;
            }

            if (json_obj.action_code == "L") {//get device list
                var select_dev = document.getElementById("drop_list_device");
                //var nDevIndex = 0;
                var array_device_list = new Array();

                var nDev = json_obj.data_field.length;
                for (var nDevIndex = 0; nDevIndex < nDev; nDevIndex++) {
                    var option = document.createElement('option');
                    option.value = nDevIndex;
                    option.text = json_obj.data_field[nDevIndex];
                    select_dev.add(option, 0);
                }
            }
            else if (json_obj.action_code == "S") {//control show
                if (json_obj.data_field == "success") {
                    sDeviceIndex = json_obj.device_index.toString();
                    writeToScreen("show or hide success");
                }
            }
            else if (json_obj.action_code == "o") {//open
                if (json_obj.data_field == "success") {
                    sDeviceIndex = json_obj.device_index.toString();
                    writeToScreen("open success");
                }
            }
            else if (json_obj.action_code == "c") {//close
                if (json_obj.data_field == "success") {
                    sDeviceIndex = json_obj.device_index.toString();
                    writeToScreen("close success");
                }
            }
            else if (json_obj.action_code == "s") {//write
            }
            else if (json_obj.action_code == "r") {//read
            }
            else if (json_obj.action_code == "t") {//transmit
            }
            else if (json_obj.action_code == "x") {//cancel
            }

            writeToScreen(JSON.stringify(json_obj));
        }

        function onError(evt) {
            writeToScreen('<span style="color: res;">error: ' + evt.data + '</span>');
        }

        function doSend(message)
        {
            //writeToScreen(message);
            websocket.send(message);
        }

        function writeToScreen(message)
        {
            var out_area = document.getElementById("output");
            out_area.style.wordWrap = "break-word";
            out_area.style.fontSize = "12px";
            out_area.innerHTML = message;
        }

        function writeToScreenAppend(message) {
            var pre = document.createElement("p");
            pre.style.wordWrap = "break-word";
            pre.style.fontSize = "12px";
            pre.innerHTML = message;

            var out_area = document.getElementById("output");
            out_area.appendChild(pre);
        }

        //window.addEventListener("load", init_run, false);

        function on_button_connect_server() {
            wsUri = "ws://127.0.0.1:80";
            writeToScreen("your ip address : " + wsUri);

            try {
                websocket = new WebSocket(wsUri, "elpusk.protocol.coffee.manager");
                websocket.onopen = function (evt) { onOpen(evt); }
                websocket.onclose = function (evt) { onClose(evt); }
                websocket.onmessage = function (evt) { onMessage_json_format(evt); }
                websocket.onerror = function (evt) { onError(evt); }
                writeToScreen("your ip address : " + wsUri);
            }
            catch (e) {
                console.log('need changed ip : chrome & firfox, opera');
                wsUri = "wss://localhost:80";

                try {
                    websocket = new WebSocket(wsUri, "elpusk.protocol.coffee.manager");
                    websocket.onopen = function (evt) { onOpen(evt); }
                    websocket.onclose = function (evt) { onClose(evt); }
                    websocket.onmessage = function (evt) { onMessage_json_format(evt); }
                    websocket.onerror = function (evt) { onError(evt); }
                    writeToScreen("your ip address : " + wsUri);
                }
                catch (e) {
                    console.log('create websocket.');
                }
            }
        }

        function on_button_disconnect_server() {
            websocket.close();
            nCount = 0;
        }
        function on_button_send_echo_to_server() {
            //alert("pressed write button.")
            //tx_data = document.getElementById("editbox_data");
            //doSend(tx_data.value);
            var s_tx = ns_get_json_string_of_request_echo(sSessionServer);
            doSend(s_tx);
        }
        function on_button_get_device_list() {
            //alert("pressed write button.")
            //tx_data = document.getElementById("editbox_data");
            //doSend(tx_data.value);
            var s_filter = "filter_hid";
            var s_tx = ns_get_json_string_of_request_get_device_list(sSessionServer, s_filter);
            doSend(s_tx);
        }

        function on_button_device_open() {
            var select_dev = document.getElementById("drop_list_device");
            var sDevPath = select_dev.options[select_dev.selectedIndex].text;
            var s_tx = ns_get_json_string_of_request_open_device(sSessionServer, sDevPath);
            doSend(s_tx);
        }
        function on_button_device_close() {
            var s_tx = ns_get_json_string_of_request_close_device(sSessionServer, sDeviceIndex);
            doSend(s_tx);
        }
        function on_button_write() {
            var tx_data = document.getElementById("editbox_data");
            var s_tx = ns_get_json_string_of_request_write_device(sSessionServer, sDeviceIndex, tx_data.value);
            doSend(s_tx);
        }
        function on_button_read() {
            var s_tx = ns_get_json_string_of_request_read_device(sSessionServer, sDeviceIndex);
            doSend(s_tx);
        }
        function on_button_transmit() {
            var tx_data = document.getElementById("editbox_data");
            var s_tx = ns_get_json_string_of_request_transmit_device(sSessionServer, sDeviceIndex, tx_data.value);
            doSend(s_tx);
        }
        function on_button_cancel() {
            var s_tx = ns_get_json_string_of_request_cancel_device(sSessionServer, sDeviceIndex);
            doSend(s_tx);
        }

        function on_button_lpu237_get_id() {
            var s_tx = ns_get_json_string_of_request_lpu237_get_id(sSessionServer, sDeviceIndex);
            doSend(s_tx);
        }
        function on_button_lpu237_enter_opos() {
            var s_tx = ns_get_json_string_of_request_lpu237_enter_opos(sSessionServer, sDeviceIndex);
            doSend(s_tx);
        }
        function on_button_lpu237_leave_opos() {
            var s_tx = ns_get_json_string_of_request_lpu237_leave_opos(sSessionServer, sDeviceIndex);
            doSend(s_tx);
        }
        function on_button_lpu237_enter_cs() {
            var s_tx = ns_get_json_string_of_request_lpu237_enter_cs(sSessionServer, sDeviceIndex);
            doSend(s_tx);
        }
        function on_button_lpu237_leave_cs() {
            var s_tx = ns_get_json_string_of_request_lpu237_leave_cs(sSessionServer, sDeviceIndex);
            doSend(s_tx);
        }
        function on_button_lpu237_uart_bypass() {
            var tx_data = document.getElementById("editbox_data");
            var s_tx = ns_get_json_string_of_request_lpu237_uart_bypass(sSessionServer, sDeviceIndex, tx_data.value);
            doSend(s_tx);
        }

        window.addEventListener("load", init, false);
    </script>
</HEAD>
<BODY>
    <h2> websocket test.</h2>
    <h3>manager commands</h3>
    <input type="button" id="button_connect_server" onclick="on_button_connect_server();" value="connect server" />
    <input type="button" id="button_disconnect_server" onclick="on_button_disconnect_server();" value="disconnect server" />
    <input type="button" id="button_echo" onclick="on_button_send_echo_to_server();" value="send echo to server" />
    <input type="button" id="button_get_list" onclick="on_button_get_device_list();" value="get device list" />
    <br />
    <input type="button" id="button_ctl_show_show" onclick="on_button_ctl_show_show();" value="show manager" />
    <input type="button" id="button_ctl_show_hide" onclick="on_button_ctl_show_hide();" value="hide manager" />
    <br />
    <br />
    <select id="drop_list_device">
    </select>
    <br />
    <h3>device commands</h3>
    <br />
    <input type="button" id="button_device_open" onclick="on_button_device_open();" value="open device" />
    <input type="button" id="button_device_close" onclick="on_button_device_close();" value="close device" />
    <br />
    <textarea id="editbox_data" rows ="2" cols="50">00a40000</textarea>
    <input type="button" id="button_lpu237_uart_bypass" onclick="on_button_lpu237_uart_bypass();" value="uart bypass" />
    <br />
    <input type="button" id="button_write" onclick="on_button_write();" value="write" />
    <input type="button" id="button_read" onclick="on_button_read();" value="read" />
    <input type="button" id="button_transmit" onclick="on_button_transmit();" value="transmit" />
    <input type="button" id="button_cancel" onclick="on_button_cancel();" value="cancel" />
    <br />
    <input type="button" id="button_lpu237_get_id" onclick="on_button_lpu237_get_id();" value="get id" />
    <br />
    <input type="button" id="button_lpu237_enter_opos" onclick="on_button_lpu237_enter_opos();" value="enter opos" />
    <input type="button" id="button_lpu237_leave_opos" onclick="on_button_lpu237_leave_opos();" value="leave opos" />
    <br />
    <input type="button" id="button_lpu237_enter_cs" onclick="on_button_lpu237_enter_opos();" value="enter cs" />
    <input type="button" id="button_lpu237_leave_cs" onclick="on_button_lpu237_leave_opos();" value="leave cs" />
    <div id="output" style="background-color:lightblue" ></div>
</BODY>
</HTML>
