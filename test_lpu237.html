<!DOCTYPE html>


<HTML>
<HEAD>
    <meta charset="utf-8" />

    <TITLE>test for javascript library</TITLE>

</HEAD>
<BODY>
    <script type="text/javascript">
        if (typeof Promise === "undefined") {
            //document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.5/bluebird.min.js"><\/script>');
            document.write('<script src="scripts/bluebird.core.min.js"><\/script>');
            document.write('<script src="scripts/elpusk.framework.coffee.js"><\/script>');
            document.write('<script src="scripts/elpusk.device.js"><\/script>');
            document.write('<script src="scripts/elpusk.device.usb.js"><\/script>');
            document.write('<script src="scripts/elpusk.device.usb.hid.js"><\/script>');
            document.write('<script src="scripts/elpusk.device.usb.hid.lpu237.js"><\/script>');
        }
        else{
            document.write('<script src="scripts/elpusk.framework.coffee.js"><\/script>');
            document.write('<script src="scripts/elpusk.device.js"><\/script>');
            document.write('<script src="scripts/elpusk.device.usb.js"><\/script>');
            document.write('<script src="scripts/elpusk.device.usb.hid.js"><\/script>');
            document.write('<script src="scripts/elpusk.device.usb.hid.lpu237.js"><\/script>');
        }
    </script>    

    <!-- fixed message area -->
    this page supports elpusk coffee JavaScript library.
    <br />
    <!-- control area -->
    <input type="button" id="button_clear_message" onclick="clearMessage();" value="clear message" />

    <br />
    <input type="button" id="button_promise_disconnect_server" onclick="on_button_promise_disconnect_server();" value="disconnect server by promise" />
    <br />
    <input type="button" id="button_promise_get_device_list" onclick="on_button_promise_get_device_list();" value="get device list by promise" />
    <br />
    <select id="drop_get_device_list">
    </select>
    <br />
    <input type="button" id="button_promise_device_close" onclick="on_button_promise_device_close();" value="close device by promise" />
    <br />

    <br />
    <input type="button" id="button_get_id" onclick="on_button_get_id();" value="get id of lpu237" />
    <br />

    <br />
    <input type="button" id="button_get_parameters" onclick="on_button_get_parameters();" value="get parameters of lpu237" />
    <br />

    <p id="p_pre_main">
        <!-- pre main print area -->
    </p>

    <p id="p_main">
        <!-- main print area -->
    </p>


    <script type="text/javascript">
        var n_system_event = 0;
        var lpu237;

        function cb_system_event( s_action_code,s_data_field ){
            do{
                if( typeof s_action_code === 'undefined'){
                    continue;
                }

                if( s_action_code === "c"){
                    //removed event
                    ++n_system_event;
                    printMessage_pre("system event [" + n_system_event.toString() + "] : removed." + s_data_field );
                }
                //

            }while(false);
        }

        function _test(){
            addMessage(" : test : ");

            var buffer = new ArrayBuffer(20);
            var uint8View = new Uint8Array(buffer);
            var uint32View = new Uint32Array(buffer);

            uint32View[0] = 511;
            uint32View[1] = 259;

            addMessage(uint8View.toString());
            addMessage(uint32View.toString());
        }


        function init() {
            if( typeof Promise === 'undefined'){
                addMessage("none promise");
            }
            else{
                addMessage("ok promise");
            }

            elpusk.framework.coffee.set_system_event_handler(cb_system_event);
            //
            var device = new elpusk.device("device");
            var usb = new elpusk.device.usb("usb");
            var hid = new elpusk.device.usb.hid("hid");

            console.log(device);
            console.log(usb);
            console.log(hid);

            console.log(device.get_path());
            console.log(usb.get_path());
            console.log(hid.get_path());

            //
            var array_device_list = [];
            var server = elpusk.framework.coffee.get_instance();

            server.connect("wss","443").then(
                function(s_session_number){
                    console.log("session : " + s_session_number);
                    return server.get_device_list("hid#vid_134b&pid_0206&mi_01");
                }
            )
            .catch(
                function(event_error){
                    console.log("connect : " + event_error);
                    throw(event_error);
                }
            )
            .then(
                function(s_rx){
                    console.log(s_rx);
                    if( s_rx == null ){
                        console.log("none device");
                    }
                    else if (Array.isArray(s_rx)) {
                        for (var i = 0; i < s_rx.length; i++) {
                            array_device_list.push( s_rx[i] );
                        }

                        if( array_device_list.length > 0 ){
                            lpu237 = new elpusk.device.usb.hid.lpu237(array_device_list[0]);
                            console.log("create : "+lpu237);
                            return server.device_open(lpu237.get_path());
                        }
                    }
                }
            )
            .catch(
                function(event_error){
                    console.log("get device list : "+event_error);
                    throw(event_error);
                }
            )
            .then(
                function( n_device_index ){
                    if( typeof n_device_index !== 'undefined'){
                        if( n_device_index!==0){
                            lpu237.opened(n_device_index);

                            var select_dev = document.getElementById("drop_get_device_list");
                            var option = document.createElement('option');
                            option.value = lpu237.get_device_index();
                            option.text = lpu237.get_path();
                            select_dev.add(option, 0);

                            console.log("opened : "+n_device_index);
                        }
                    }
                }
            )
            .catch(
                function(event_error){
                    console.log("open device : "+event_error);
                }
            );


            // 
            console.log("the end of init");
            _test();          
        }

        window.addEventListener("load", init, false);

        function clearMessage() {
            var parag_main = document.getElementById("p_main");
            parag_main.style.wordWrap = "break-word";
            parag_main.style.fontSize = "12px";
            parag_main.innerHTML ="";
        }

        function printMessage(Message)
        {
            var parag_main = document.getElementById("p_main");
            parag_main.style.wordWrap = "break-word";
            parag_main.style.fontSize = "12px";
            parag_main.innerHTML = Message + "<br />";
        }
        function addMessage(Message) {
            var parag_main = document.getElementById("p_main");
            parag_main.style.wordWrap = "break-word";
            parag_main.style.fontSize = "12px";
            parag_main.innerHTML += (Message + "<br />");
        }

        function printMessage_pre(Message)
        {
            var parag_main = document.getElementById("p_pre_main");
            parag_main.style.wordWrap = "break-word";
            parag_main.style.fontSize = "14px";
            parag_main.innerHTML = Message + "<br />";
        }
        function addMessage_pre(Message) {
            var parag_main = document.getElementById("p_pre_main");
            parag_main.style.wordWrap = "break-word";
            parag_main.style.fontSize = "14px";
            parag_main.innerHTML += (Message + "<br />");
        }
        //////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////////

        //////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////////

        function on_button_promise_disconnect_server() {
            var server = elpusk.framework.coffee.get_instance();

            server.disconnect().then(function (s_session_number) {
                // server is ready here
                addMessage("disconnected : session number = " + s_session_number);
            }).catch(function (event_error) {
                // error here
                addMessage("fail : disconnection : "+ server.get_error_message(event_error));
            });
        }

        function on_button_promise_device_close() {
            var server = elpusk.framework.coffee.get_instance();
            server.device_close(lpu237.get_device_index()).then(function (s_rx) {
                do{
                    if (!Array.isArray(s_rx)) {
                        addMessage("erro reponse : " + s_rx);
                        continue;
                    }
                    if (s_rx === null) {
                        addMessage("invalied response");
                        continue;
                    }
                    else if( s_rx != "success" ){
                        addMessage("close failure");
                        continue;
                    }

                    lpu237.closed();
                    addMessage("close success");

                }while(false);

            }).catch(function (event_error) {
                // error here
                addMessage("fail : device close : "+ server.get_error_message(event_error));
            });
        }

        ///////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////
        function on_button_get_id(){
            var server = elpusk.framework.coffee.get_instance();
            server.device_transmit(lpu237.get_device_index(),0,0,lpu237.get_request_data_field_of_get_id())
            .then(
                function (s_rx) {
                    do{
                        if( !lpu237.is_valid_response(s_rx) ){
                            addMessage("received : " + "invalid");
                            continue;
                        }
                        if( !lpu237.is_good_response(s_rx) ){
                            addMessage("received : " + "error");
                            continue;
                        }

                        var s_data = lpu237.get_data_field(s_rx);

                        addMessage("received ID : " + s_data);

                    }while(false);
                }
            ).catch(function (event_error) {
                // error here
                addMessage("fail : device transmit : "+ server.get_error_message(event_error));
            });

        }        

        function on_button_get_parameters()
        {
            var server = elpusk.framework.coffee.get_instance();

            do{
                server.device_transmit(lpu237.get_device_index(),0,0,lpu237.get_request_data_field_of_enter_cs())
                .then(
                    function (s_rx) {
                        do{
                            if( !lpu237.is_valid_response(s_rx) ){
                                addMessage("received : " + "invalid");
                                continue;
                            }
                            if( !lpu237.is_good_response(s_rx) ){
                                addMessage("received : " + "error");
                                continue;
                            }

                            addMessage("enter cs");
                        }while(false);
                    }
                ).catch(function (event_error) {
                    // error here
                    addMessage("fail : enter cs : "+ server.get_error_message(event_error));
                    throw(event_error);
                });
                //
            }while(false);

        }

    </script>
</BODY>
</HTML>
